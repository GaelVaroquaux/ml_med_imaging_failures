var shared_errors={},shared_strings={},shared_http={},shared_requests={},shared_numbers={},shared_collections={},shared_html={},shared_selection={},recommendation_recommendation={},text_text={},shared_storage={},shared_location={},shared_state={},shared_events={},shared_messaging={},shared_component={},shared_templates={},shared_forms={},email_this_email_this={},recommendation_journey_recommendation_journey={},minimised_minimised={},email_journey_email={},shared_scroll={},shared_functions={},pre_rec_email_journey_pre_rec_email={},pre_rec_plugin_journey_pre_rec_plugin={},shared_cookies={},popup_popup={},inline_inline={},config_config={},application_application={},iframe_client={},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_errors=function(t){var e=function(){function t(){}return t.unhandled=function(t){r.log(t)},t.capture=function(e){return function(){try{e()}catch(e){t.unhandled(e)}}},t}();t.UnhandledError=e;var n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(Error);t.NoSuchElement=n;var r=function(){function t(){}return t.log=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];t.enabled&&console.log(e,n)},t.enable=function(e){t.enabled=e},t.isDebug=function(t){return t.indexOf("uptodate-debug=true")!=-1},t.enabled=!1,t}();return t.Debug=r,t}(shared_errors),shared_strings=function(t){function e(t){return null==t||""==t}function n(t){if("undefined"==typeof t||"undefined"==t)return null;try{return JSON.parse(t)}catch(e){return t}}function r(t,e){return 0==e.indexOf(t)}function o(t,e){return e.indexOf(t)==e.length-t.length}return t.isEmpty=e,t.coerce=n,t.startsWith=r,t.endsWith=o,t}(shared_strings),shared_http=function(t,e,n){function r(n,r){if(void 0===r&&(r=t.fireAndForget),JSON.stringify(n)==JSON.stringify(c))return e.Debug.log("duplicate request",n,c),function(){};c=n;var o=new XMLHttpRequest;o.open(n.method,n.url,!0),o.withCredentials=!0;var i=n.headers||{};return Object.keys(i).forEach(function(t){o.setRequestHeader(t,i[t])}),o.addEventListener("readystatechange",e.UnhandledError.capture(function(){if(4==o.readyState){var t=o.getAllResponseHeaders().split("\n").reduce(function(t,e){var n=e.split(": ");return t[n[0]]=n[1],t},{});r({status:o.status,headers:t,entity:new a(o.responseText)})}})),o.send(n.entity),function(){o.abort()}}function o(t){var e=document.createElement("a");return e.href=t,{scheme:e.protocol?e.protocol.replace(/(:$)/,""):"",host:e.hostname,authority:e.host,path:0===e.pathname.indexOf("/")?e.pathname:"/"+e.pathname,query:e.search?e.search.replace(/(^\?)/,""):"",fragment:e.hash?e.hash.replace(/(^#)/,""):"",toString:function(){var t=[];return""!=this.scheme&&(t.push(this.scheme),t.push(":")),""!=this.authority&&(t.push("//"),t.push(this.authority)),t.push(this.path),""!=this.query&&(t.push("?"),t.push(this.query)),""!=this.fragment&&(t.push("#"),t.push(this.fragment)),t.join("")}}}function i(t){void 0===t&&(t=document.location.href);var e=o(t).query;return""==e?{}:e.split("&").map(function(t){return t.split("=")}).reduce(function(t,e){var r=e[0],o=n.coerce(e[1]),i=t[r];return"undefined"==typeof i?t[r]=o:"object"==typeof i?i.push(o):t[r]=[i,o],t},{})}function s(t){var e=[];return Object.keys(t).forEach(function(n){var r=t[n];null==r?e.push(encodeURIComponent(n)):"object"==typeof r?r.forEach(function(t){e.push(encodeURIComponent(n)+"="+encodeURIComponent(t))}):e.push(encodeURIComponent(n)+"="+encodeURIComponent(r))}),e.join("&")}var a=function(){function t(t){this.content=t}return t.prototype.xml=function(){return(new DOMParser).parseFromString(this.content,"application/xml")},t.prototype.text=function(){return this.content},t.prototype.json=function(){return JSON.parse(this.content)},t.prototype.html=function(){return(new DOMParser).parseFromString(this.content,"text/html")},t}();t.Entity=a,t.fireAndForget=function(t){};var c={};t.http=r,t.uri=o,t.queryObject=i,t.toQueryString=s;var u=function(){function t(){}return t.baseUrl=function(t){var e={regex:new RegExp("(https?://[^/]+/[^/]+/).*"+t),process:function(t){return t.match(e.regex)[1]}};try{throw new Error}catch(n){try{return e.process(n.stack)}catch(n){return e.process(document.querySelector('script[src$="'+t+'"]').src)}}},t.origin=function(t){var e=document.createElement("a");return e.href=t,e.protocol+"//"+e.host},t}();return t.BaseUrl=u,t}(shared_http,shared_errors,shared_strings),shared_requests=function(t){var e=function(){function t(){}return t.config=function(t,e){return{method:"POST",headers:{Accept:"application/json","Content-Type":"text/plain"},url:t+"user/config",entity:JSON.stringify(e)}},t.postEvent=function(t){return{method:"POST",url:t.config.host+"events/"+encodeURIComponent(t.event.subject)+"_"+encodeURIComponent(t.event.action)+"_"+encodeURIComponent(t.event.object),headers:{"Content-Type":"text/plain"},entity:JSON.stringify(t)}},t.get=function(t){return{method:"GET",url:t}},t.recommendations=function(t){return{method:"POST",headers:{Accept:"application/json","Content-Type":"text/plain"},url:t.config.host+"recommendations",entity:JSON.stringify(t)}},t.jobRecommendations=function(t){return t.config.number_of_recommendations=3,{method:"POST",headers:{Accept:"application/json","Content-Type":"text/plain"},url:t.config.host+"recommendations/jobs",entity:JSON.stringify(t)}},t}();return t.Requests=e,t}(shared_requests),shared_numbers=function(t){function e(t,e){return Math.floor(Math.random()*(e-t+1))+t}return t.randomInteger=e,t}(shared_numbers);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_collections=function(t,e,n){function r(t){for(var n=t.length-1;n>0;n--){var r=e.randomInteger(0,n),o=t[n];t[n]=t[r],t[r]=o}return t}function o(t){var e=new s;if(!t)return e;for(var n=0;n<t.length;++n)e.push(t[n]);return e}function i(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var n={},r=function(e){var r=t[e];return null==r?"continue":void Object.keys(r).forEach(function(t){n[t]=r[t]})},o=0;o<t.length;o++)r(o);return n}t.shuffle=r;var s=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.each=function(t){for(var e=0;e<this.length;++e)t(this[e],e);return this},e.prototype.map=function(t){var n=new e;return this.each(function(e,r){n.push(t(e,r))}),n},e.prototype.flatMap=function(t,n){return void 0===n&&(n=new e),this.each(function(e,r){var o=t(e,r);Array.prototype.push.apply(n,o)}),n},e.prototype.filter=function(t){var n=new e;return this.each(function(e,r){t(e)&&n.push(e)}),n},e.prototype.find=function(t){return this.filter(t).head()},e.prototype.as=function(t){var e=this;return e.filter(function(e){return e instanceof t})},e.prototype.head=function(){return this[0]},e.prototype.last=function(){if(this.isEmpty())throw new n.NoSuchElement;return this[this.length-1]},e.prototype.isEmpty=function(){return 0==this.length},e.prototype.groupBy=function(t){return this.reduce(function(n,r){var o=t instanceof Function?t(r):r[t];return(n[o]=n[o]||new e).push(r),n},{})},e}(Array);return t.List=s,t.list=o,t.mergeObjects=i,t}(shared_collections,shared_numbers,shared_errors),shared_html=function(t,e,n){function r(t,e){for(var n=i(e),r=0;r<n.length;r++){var o=n[r];t.appendChild(o)}return t}function o(t){return void 0!==t.outerHTML}function i(t){var e=document.createElement("div");return e.innerHTML=o(t)?t.outerHTML:t,e.childNodes}function s(t,e){for(var n=t.parentNode,r=i(e),o=0;o<r.length;o++){var s=r[o];n.insertBefore(s,t)}return t}function a(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return function(e){for(var n=0;n<t.length;n++){var r=t[n];Object.keys(r).forEach(function(t){var n=r[t],o=typeof n;switch(o){case"function":e.setAttribute(t,n(e.getAttribute(t)));break;case"boolean":n?e.setAttribute(t,""):e.removeAttribute(t);break;case"object":e.setAttribute(t,JSON.stringify(n));break;default:e.setAttribute(t,n)}})}return e}}function c(t,e,n,r){"string"==typeof e&&(e=[e]);for(var o=0;o<e.length;o++){var i=e[o];t.addEventListener(i,function(t){var e=n(t);e||(t.preventDefault(),t.stopPropagation())},r)}}function u(){return"BackCompat"==document.compatMode?document.body:document.documentElement}function l(t){return void 0===t&&(t=u()),t.scrollHeight>t.clientHeight}function h(t){return void 0===t&&(t=u()),t.scrollWidth>t.clientWidth}function p(t){return n.select("dt",t).reduce(function(t,e){return t[e.textContent.trim()]=e.nextElementSibling.textContent.trim(),t},{})}var d=function(){function t(){}return t.path=function(t){for(var n=new e.List;t;)n.push(t),t=t.parentElement;return n},t.matches=function(t,e){return t.matches=t.matches||t.msMatchesSelector||function(t){return!1},t.matches(e)},t.calculateBoxShadow=function(e){try{var n=t.path(e).map(function(t){return window.getComputedStyle(t).boxShadow}).find(function(t){return"none"!=t});return parseInt(n.split("px ")[2])}catch(t){return 0}},t}();return t.Elements=d,t.appendHtml=r,t.isHTML=o,t.parseHtml=i,t.insertHtml=s,t.attributes=a,t.on=c,t.root=u,t.hasVerticalScrollBar=l,t.hasHorizontalScrollBar=h,t.dataListObject=p,t}(shared_html,shared_collections,shared_selection);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};shared_selection=function(t,e,n){function r(t,e){function n(e,n){for(var r=n.querySelectorAll(t),o=0;o<r.length;++o)e.push(r[o]);return e}void 0===e&&(e=document);var r=new i;if("string"!=typeof t)return r.push(t),r;if(e instanceof i){for(var o=0;o<e.length;o++){var s=e[o];n(r,s)}return r}return n(r,e)}function o(t,e){return void 0===e&&(e=document),e.querySelector(t)}var i=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.on=function(t,e,r){return this.each(function(o){n.on(o,t,function(t){return e(o,t)},r)})},r.prototype.attr=function(t,e){return null==e?this.map(function(e){return e.getAttribute(t)}):this.each(function(n){n.setAttribute(t,e)})},r.prototype.removeAttr=function(t){return this.each(function(e){e.removeAttribute(t)})},r.prototype.prop=function(t,e){return null==e?this.map(function(e){return e[t]}):this.each(function(n){n[t]=e})},r.prototype.text=function(t){return null==t?this.map(function(t){return t.textContent}):this.each(function(e){e.textContent=t})},r.prototype.html=function(t){return null==t?this.map(function(t){return t.innerHTML}):this.each(function(e){e.innerHTML=t})},r.prototype.css=function(t,e){return null==e?this.map(function(e){return window.getComputedStyle(e).getPropertyValue(t)}):this.each(function(n){n.style[t]=e})},r.prototype.append=function(t){return this.map(function(e){return n.appendHtml(e,t)}),this},r.prototype.appendTo=function(t){return this.each(function(e){t.appendChild(e)})},r.prototype.insert=function(t){return this.map(function(e){return n.insertHtml(e,t)}),this},r.prototype.remove=function(t){return void 0===t&&(t=function(t){return!0}),this.each(function(e){t&&e.parentNode.removeChild(e)})},r.prototype.children=function(){return this.flatMap(function(t){return e.list(t.childNodes)},new r)},r.prototype.detach=function(){var t=document.createDocumentFragment();return this.each(function(e){t.appendChild(e)}),t},r.prototype.clone=function(){var t=document.createDocumentFragment();return this.each(function(e){t.appendChild(e.cloneNode(!0))}),t},r.prototype.show=function(){return this.each(function(t){t.style.display=""})},r.prototype.hide=function(){return this.each(function(t){t.style.display="none"})},r.prototype.addClass=function(t){return this.each(function(e){e.classList.add(t)})},r.prototype.removeClass=function(t){return this.each(function(e){e.classList.remove(t)})},r}(e.List);return t.Select=i,t.select=r,t.get=o,t}(shared_selection,shared_collections,shared_html),recommendation_recommendation=function(t,e){var n=function(){function t(t){this.publishers=["10.3858","10.1013","10.1038","10.1057","10.1245","10.1251","10.1114","10.26778","10.26777","10.3758","10.1186","10.1140","10.7603","10.1361","10.1379","10.1381","10.1385","10.2165","10.1007","10.1065","10.1023","10.4333","10.5822","10.5819","10.1617","10.5052","10.4056"],this.element=e.get(".recommendation",t)}return t.prototype.render=function(t){var n=e.get(".link",this.element);n.href=t.link,n.title=this.capitalizeWhenUpperCase(t.title,n,t);var r=e.get(".title",this.element);r.innerHTML=t.title;for(var o=e.get(".author",this.element),i=[],s=0;s<t.authors.length;s++)o.textContent=this.capitalizeWhenUpperCase(t.authors[s],o,t),i.push(o.outerHTML);e.get(".authors",this.element).innerHTML=i.join("");var a=e.get(".journal",this.element);a.textContent=this.capitalizeWhenUpperCase(t.journal,a,t);var c=e.get(".year",this.element);if(c.textContent="",t.pubdate){var u=new Date(t.pubdate).getFullYear();0==isNaN(u)&&1970!=u&&(c.textContent=String(u))}},t.prototype.capitalizeWhenUpperCase=function(t,e,n){return null==t?"":this.publishers.indexOf(n.doi.split("/")[0])?t:t.toUpperCase()!=t?t:(e.classList.add("capitalise"),t.toLowerCase())},t}();t.RecommendationRenderer=n;var r=function(){function t(t){this.element=e.get(".recommendation",t)}return t.prototype.render=function(t){var n=e.get(".link",this.element);n.href=t.redirectUrl,n.title=t.title,e.get(".job-title",this.element).innerHTML=t.title,e.get(".company",this.element).innerHTML=t.company},t}();return t.JobRecommendationRenderer=r,t}(recommendation_recommendation,shared_selection),text_text=function(t,e,n,r){function o(t,e){return i(e)>i(t)}function i(t){return t.offsetHeight+t.offsetTop}var s=function(){function t(){}return t.each=function(t,n,r,o){for(var i,s=function(t){return!e.isEmpty(t)&&o?o(t):null},a=0;null!=(i=n.exec(t));)s(t.substring(a,i.index)),r(i),a=n.lastIndex;s(t.substring(a))},t.replace=function(n,r,o,i){var s=[],a=function(t){return!e.isEmpty(t)&&i?s.push(i(t)):null},c=function(t){return s.push(o(t))};return t.each(n,r,c,a),s.join("")},t}();t.Regex=s;var a=function(){function t(t,e,n,r,o){void 0===t&&(t="word"),void 0===e&&(e="overflowed"),void 0===n&&(n="line-start"),void 0===r&&(r="line-end"),void 0===o&&(o="ellipsis"),this.word=t,this.overflowed=e,this.lineStart=n,this.lineEnd=r,this.ellipsisClass=o}return t.prototype.words=function(t){var e=this;n.list(t.childNodes).forEach(function(n){if(!(n instanceof Element&&"span"==n.tagName.toLocaleLowerCase()&&n.classList.contains(e.word)))if(n instanceof Text){var r=document.createDocumentFragment();s.each(n.wholeText,/\s+/g,function(t){r.appendChild(document.createTextNode(t[0]))},function(t){var n=document.createElement("span");n.classList.add(e.word),n.appendChild(document.createTextNode(t)),r.appendChild(n)}),t.replaceChild(r,n)}else e.words(n)})},t.prototype.overflow=function(t){var e=this,n=!1;this.allWords(t).each(function(r){o(t,r)&&(n=!0),n?r.classList.add(e.overflowed):r.classList.remove(e.overflowed)})},t.prototype.allWords=function(t){return r.select("."+this.word,t).as(HTMLElement)},t.prototype.visibleWords=function(t){return r.select("."+this.word+":not(."+this.overflowed+")",t).as(HTMLElement)},t.prototype.lastWord=function(t){return this.visibleWords(t).last()},t.prototype.lines=function(t){var e=this,n=this.visibleWords(t).groupBy(function(t){return t.offsetTop});Object.keys(n).map(function(t){return n[t]}).forEach(function(t){t.each(function(t){return t.classList.remove(e.lineStart,e.lineEnd)}),t.head().classList.add(e.lineStart),t.last().classList.add(e.lineEnd)})},t.prototype.ellipsis=function(t){var e=this;r.select(this.ellipsisClass).each(function(t){t.classList.remove(e.ellipsisClass),t.textContent=t.getAttribute("original-text")});var n=this.lastWord(t);if(this.allWords(t).last()!=n){var i=n.getAttribute("original-text")||n.textContent;n.setAttribute("original-text",i),n.classList.add(this.ellipsisClass);for(var s=i.length;s>0&&(n.textContent=i.substr(0,s)+"…",o(t,n));s--);}},t.prototype.squeeze=function(t,e){var n=this.lastWord(t);n.parentElement.insertBefore(e,n.nextElementSibling),o(t,e)&&(n.classList.add(this.overflowed),this.squeeze(t,e))},t.prototype.process=function(t,e){this.words(t),this.overflow(t),e&&this.squeeze(t,e),this.ellipsis(t),this.lines(t)},t}();return t.StructuredText=a,t.overflowed=o,t.offsetBottom=i,t}(text_text,shared_strings,shared_collections,shared_selection),shared_storage=function(t,e){function n(){try{var t="uptodate-test",e="works";window.localStorage.setItem(t,e);var n=window.localStorage.getItem(t);return window.localStorage.removeItem(t),e===n}catch(t){return!1}}function r(t){void 0===t&&(t=window.localStorage);for(var n={},r=0;r<t.length;r++){var o=t.key(r);n[o]=e.coerce(t.getItem(o))}return n}function o(t,n,r){Object.keys(t).forEach(function(o){if(e.startsWith(r,o)){var i=t[o];null==i||"undefined"==typeof i?n.removeItem(o):n.setItem(o,i)}})}return t.LOCALSTORAGE_KEY="uptodate-user-id",t.hasStorage=n,t.storageObject=r,t.copyIntoStorage=o,t}(shared_storage,shared_strings),shared_location=function(t,e,n,r,o){var i=function(){function t(e,n,r,o,i,s,a,c,u,l){void 0===e&&(e=t.extractType()),void 0===n&&(n=t.extractDisplayType()),void 0===r&&(r=t.extractDesignType()),void 0===o&&(o=t.extractDoi()),void 0===i&&(i=t.extractIssn()),void 0===s&&(s=window.location.href),void 0===a&&(a=t.extractHostsite(s)),void 0===c&&(c=t.extractMetaData(e)),void 0===u&&(u=t.extractSessionIds()),void 0===l&&(l=!1),this.type=e,this.display_type=n,this.design_type=r,this.doi=o,this.issn=i,this.url=s,this.hostsite=a,this.meta_data=c,this.session_ids=u,this.browser_extension_loaded=l,this.dois=o?[o]:[]}return t.prototype.checkForBrowserExtension=function(t,e){if("chrome"in window&&t){var n=this;window.chrome.runtime.sendMessage(t,{type:"browserExtensionInstalledRequest"},function(t){n.browser_extension_loaded=!!t,e()})}else e()},t.extractSessionIds=function(){var t=[];if(o.hasStorage()){var e=window.localStorage.getItem(o.LOCALSTORAGE_KEY);null!=e&&t.push(e)}return t},t.extractHostsite=function(t){var e,r=n.uri(t),o=n.queryObject(t)["uptodate-hostsite"];return e=o?o:r.authority,e.indexOf("recommendations.springernature.com")!=-1||e.indexOf("recommended.springernature.com")!=-1?"recommended":e.indexOf("nature.com")!=-1?"nature":e.indexOf("springer.com")!=-1?"springer":e.indexOf("biomedcentral.com")!=-1?"biomedcentral":e.indexOf("springeropen.com")!=-1?"springeropen":e.indexOf("localhost")!=-1?"localhost":"unknown"},t.prototype.toQuery=function(){return encodeURIComponent(this.json())},t.prototype.json=function(){return JSON.stringify(this)},t.extractDisplayType=function(){return e.get(t.inlineSelector,document)?"inline":"popup"},t.extractDesignType=function(){return e.get("link[href*=mosaic], meta[name='WT.template'][content=mosaic]",document)?"mosaic":"unknown"},t.extractType=function(){var n=t.extractDoi();if(n)return"article";var r=e.select("meta[name='citation_article_type'], meta[name='WT.cg_s'], meta[name='dc.type']").attr("content").head();if(r){var o=r.toLowerCase();if("latest research"==o&&(o="research"),"jobs"==o&&(o="job"),t.allowedTypes.indexOf(o)!=-1)return o}return 0==document.title.indexOf("Table of contents")?"issue":"Natureevents"==e.select("meta[name='WT.cg_n']").attr("content").head()?"event":"Home"==e.select("meta[name='WT.page_categorisation']").attr("content").head()?"journalHomepage":null},t.extractMetaData=function(t){switch(t){case"job":return{job:{id:e.select("meta[name='DCSext.job_id']").attr("content").head(),title:e.select("meta[name='description']").attr("content").head(),location:e.select("meta[name='Job Location']").attr("content").head(),employer:e.select("meta[name='Job Employer']").attr("content").head(),employer_id:e.select("meta[name='DCSext.employer_id']").attr("content").head(),type:e.select("meta[name='Job Type']").attr("content").head(),qualifications:e.select("meta[name='Job Qualifications']").attr("content").head()}};case"event":var n=r.dataListObject(e.get('dl[class="event-details"]'));return{event:{id:e.select("meta[name='DCSext.event_id']").attr("content").head(),title:document.title.trim(),organization:n["Organization:"],type:n["Type:"],venue:n["Venue:"],location:n["Location:"],website:n["Website:"],area:n.Area,specialty:n.Specialty,subject:n.Subject}}}return{}},t.extractDoi=function(){var n=e.select("meta[name='citation_doi'], meta[name='dc.identifier'], meta[name='DC.identifier'], meta[name='prism.doi'], meta[name='dc.Identifier'], meta[property='citation_doi']").attr("content");return n.isEmpty()&&(n=e.select("a[ref='aid_type=doi']").text()),n.isEmpty()&&(n=e.select("meta[name='citation_arxiv_id']").attr("content").map(function(t){return"arxiv:"+t})),n.map(function(e){if(!e)return null;var n=e.match(t.doiRegex);return null!=n?n[1]:null}).filter(function(t){return null!=t}).head()},t.extractIssn=function(){var t=e.select("meta[name='citation_issn'], meta[name='prism.issn'], meta[name='prism.eIssn']").attr("content").head();if(t)return t.toUpperCase();var n=e.select(".issn, .eissn").text().head(),r=n?n.match(this.issnRegex):null;return r?r[0].toUpperCase():null},t.inlineSelector="div[data-rel='uptodate-inline'], link[rel='uptodate-inline']",t.allowedTypes=["article","research","issue","homepage","job","event"],t.trackTypes=["article","job","event"],t.doNotDisplay=["job","event"],t.doiRegex=/.*(10\.\d{4,9}\/[-._;()\/:A-Z0-9]+).*/i,t.issnRegex=/\d{4}\-\d{3}[\dxX]/i,t}();return t.CurrentLocation=i,t}(shared_location,shared_selection,shared_http,shared_html,shared_storage),shared_state=function(t,e,n,r,o,i,s){function a(t,e,n){return void 0===e&&(e=new r.CurrentLocation),void 0===n&&(n=window.screen),h.toUnderscore({config:t,current_location:e,screen:n})}function c(t){return null!=t&&t.constructor==Array}function u(t){return null!=t&&"object"==typeof t}t.state=a;var l=function(){function t(t,e){void 0===e&&(e=new o.ConsoleEventHandler),this.root=t,this.events=e,this.capture(),this.setInitialState()}return t.prototype.capture=function(){var t=this;i.on(this.root,"change",function(e){var n=e.target;return i.Elements.matches(n,".state[name][value]")&&t.setState(n),i.Elements.matches(n,"[data-event-subject][data-event-action][data-event-object]")&&t.trackEvent(n),!0},!0),i.on(this.root,["click","contextmenu"],function(e){var n=o.Events.path(e).find(function(t){return i.Elements.matches(t,":not(.state)[data-event-object]")});return n&&t.trackEvent(n),!0},!0)},t.prototype.setState=function(t){var n=e.get("input[name="+t.name+"]",this.root),r=n.getAttribute("state-new")||"",o=t.value;r!=o&&(n.setAttribute("state-old",r),n.setAttribute("state-new",o))},t.prototype.trackEvent=function(t){var e=this.dataAttributes(t);this.events.fire(encodeURIComponent(t.getAttribute("data-event-subject")),encodeURIComponent(t.getAttribute("data-event-action")),encodeURIComponent(t.getAttribute("data-event-object")),e)},t.prototype.dataAttributes=function(t,e){var r=this;return void 0===e&&(e={}),s.list(t.attributes).filter(function(t){return n.startsWith("data-",t.name)}).filter(function(t){return!n.startsWith("data-event",t.name)}).reduce(function(t,e){return t[encodeURIComponent(e.name.replace("data-",""))]=r.getAttributeValue(e),t},e)},t.prototype.getAttributeValue=function(t){try{return JSON.parse(t.value)}catch(e){return t.value}},t.prototype.setInitialState=function(){var t=this;e.select(".state[name][value]:not([state-new]):checked",this.root).as(HTMLInputElement).each(function(n){var r=e.get("input[name="+n.name+"]",t.root);r.setAttribute("state-new",r.defaultValue)})},t}();t.StateChange=l,t.isArray=c,t.isObject=u;var h=function(){function t(){}return t.toUnderscore=function(t){return this.map(t,function(t){return t.replace(/-/g,"_")})},t.toHyphen=function(t){return this.map(t,function(t){return t.replace(/_/g,"-")})},t.map=function(t,e){var n=this;if(c(t)){var r=t;return r.reduce(function(t,r){return t.push(n.map(r,e)),t},[])}if(u(t)){var o={};for(var i in t){var s=t[i];null!=s&&"function"!=typeof s&&(o[e(i)]=this.map(s,e))}return o}return t},t}();return t.Converter=h,t}(shared_state,shared_selection,shared_strings,shared_location,shared_events,shared_html,shared_collections),shared_events=function(t,e,n,r,o,i){var s=function(){function t(){}return t.prototype.fire=function(t,e,n,r){console.log&&console.log("Event: "+t+" "+e+" "+n+" -> "+JSON.stringify(r))},t}();t.ConsoleEventHandler=s;var a=function(){function t(t){this.state=t}return t.prototype.fire=function(t,i,s,a){r.http(n.Requests.postEvent(e.Converter.toUnderscore(o.mergeObjects(this.state,{event:{subject:t,action:i,object:s,data:a,client_time:this.toIsoStringWithOffset(new Date)}}))))},t.prototype.toIsoStringWithOffset=function(t){var e=-t.getTimezoneOffset(),n=e>=0?"+":"-",r=function(t){var e=Math.abs(Math.floor(t));return(e<10?"0":"")+e};return t.getFullYear()+"-"+r(t.getMonth()+1)+"-"+r(t.getDate())+"T"+r(t.getHours())+":"+r(t.getMinutes())+":"+r(t.getSeconds())+n+r(e/60)+":"+r(e%60)},t.create=function(t,e){if(void 0===e&&(e={bubbles:!0,cancelable:!0,detail:null}),e.detail)try{return new CustomEvent(t,e)}catch(r){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n}else try{return new Event(t,e)}catch(n){var r=document.createEvent("Event");return r.initEvent(t,e.bubbles,e.cancelable),r}},t.path=function(t){return i.Elements.path(t.target)},t}();return t.Events=a,t}(shared_events,shared_state,shared_requests,shared_http,shared_collections,shared_html),shared_messaging=function(t,e,n,r,o){var i=function(){function t(){}return t.fireResize=function(e,n,r){var i,s=r||"resize";if(n instanceof HTMLElement){var a=o.Elements.calculateBoxShadow(n);i={width:n.offsetWidth+a+"px",height:n.offsetHeight+a+"px"}}else i=n;t.dispatch(e,{name:s,body:i})},t.dispatch=function(t,n){t.dispatchEvent(e.Events.create("client_message",{bubbles:!0,cancelable:!0,detail:n}))},t}();t.MessageDispatcher=i;var s=function(){function t(t,e){var o=this;this.window=t,this.expectedOrigin=e,t.addEventListener("message",function(i){var s=n.uri(i.origin).host,a=n.uri(e).host;if(s!=a)return void r.Debug.log("Origin host did not match expected: expectedHost:"+a+" actualHost:"+s);var c=i.data;r.Debug.log(t.name+" received message from "+e+" : "+c.name+" -> "+JSON.stringify(c.body));var u=o[c.name];if(!u)return void r.Debug.log("No slot called "+c.name+" found");try{u.call(o,c.body)}catch(t){r.UnhandledError.unhandled(t)}},!0)}return t}();t.MessageReceiver=s;var a=function(){function t(t,e){this.windows=t,this.destinationOrigin=e}return t.prototype.send=function(t,e){var n=this;this.windows.forEach(function(r){r.postMessage({name:t,body:e},n.destinationOrigin)})},t}();return t.MessageSender=a,t}(shared_messaging,shared_events,shared_http,shared_errors,shared_html),shared_component=function(t,e,n,r,o){var i=function(){function t(t,e){this.root=n.get(t,e)}return t.prototype.fireResize=function(t){var e;if(t instanceof HTMLElement){var n=o.Elements.calculateBoxShadow(t);e={width:t.offsetWidth+n+"px",height:t.offsetHeight+n+"px"}}else e=t;r.MessageDispatcher.dispatch(this.root,{name:"resize",body:e})},t.prototype.fireInlineEvent=function(t){r.MessageDispatcher.dispatch(this.root,{name:"inlineEvent",body:t})},t.prototype.reset=function(t,r){void 0===t&&(t=!0),void 0===r&&(r=!0),this.animate(r),n.select(".state",this.root).as(HTMLInputElement).each(function(n){n.checked!=n.defaultChecked&&(n.checked=n.defaultChecked,t&&n.dispatchEvent(e.Events.create("change")))}),this.animate(!0)},t.prototype.animate=function(t){t?this.root.classList.remove("disable-animate"):this.root.classList.add("disable-animate")},t.prototype.stateInput=function(t,e){return n.get('input[name="'+t+'"][value="'+e+'"],input[name="'+t+'"][value="\\"'+e+'\\""]',this.root)},t.prototype.hasState=function(t,e){return this.stateInput(t,e).checked},t.prototype.set=function(t,n,r){void 0===r&&(r=!0);var o=this.get(t),i=this.stateInput(t,n);return i.checked=!0,r&&i.dispatchEvent(e.Events.create("change")),o},t.prototype.fire=function(t){var r=n.get('input[name="'+t+'"]:checked',this.root);r.dispatchEvent(e.Events.create("change"))},t.prototype.get=function(t){var e=n.get('input[name="'+t+'"]:checked',this.root);return e?e.value:e},t}();return t.Component=i,t}(shared_component,shared_events,shared_selection,shared_messaging,shared_html),shared_templates=function(t,e){var n=function(){function t(){}return t.clone=function(t){return this.polyfill(t),t.ownerDocument.importNode(t.content,!0)},t.polyfill=function(t){t.content||(t.content=e.select(t).children().detach())},t.polyfillTemplates=function(t){var n=this;e.select("template",t).each(function(t){return n.polyfill(t)})},t}();return t.Templates=n,t}(shared_templates,shared_selection),shared_forms=function(t,e){function n(t){var n=e.select("input[name], textarea[name], select[name]",t),r=n.filter(function(t){return!(("radio"==t.type||"checkbox"==t.type)&&!t.checked)}).map(function(t){return encodeURIComponent(t.name)+"="+encodeURIComponent(t.value)}).join("&"),o=(t.getAttribute("method")||"GET").toUpperCase(),i=t.getAttribute("action"),s={},a="";return"GET"==o&&(i=i+"?"+r),"POST"==o&&(s["Content-Type"]="application/x-www-form-urlencoded",a=r),{method:o,url:i,headers:s,entity:a}}return t.request=n,t}(shared_forms,shared_selection);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};email_this_email_this=function(t,e,n,r,o,i,s){var a=function(t){function e(e,n){t.call(this,".email-this",e),this.state=n}return __extends(e,t),e.prototype.attachToForm=function(){var t=this,e=n.get("form.card-send",this.root);r.on(e,"submit",function(){e.action=t.state.config.host+"send-article";var r=n.get("input[name=state]",e);return r.value=JSON.stringify(t.state),t.sending(),o.Debug.log("attempting to subscribe"),i.http(s.request(e),function(e){e.status>=299?(o.Debug.log("failed to send"),t.error()):(o.Debug.log("succeeded in sending"),t.sent())}),!1})},e.prototype.reset=function(e,r){void 0===e&&(e=!0),void 0===r&&(r=!0);var o=n.get("form.card-send",this.root);return o.reset(),t.prototype.reset.call(this,e,r)},e.prototype.send=function(){this.set("send-state","initial")},e.prototype.sending=function(){this.set("send-state","sending")},e.prototype.error=function(){this.set("send-state","error")},e.prototype.sent=function(){this.set("send-state","sent")},e}(e.Component);return t.EmailThis=a,t}(email_this_email_this,shared_component,shared_selection,shared_html,shared_errors,shared_http,shared_forms);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};recommendation_journey_recommendation_journey=function(t,e,n,r,o,i,s,a){var c=function(t){function r(e,n){t.call(this,".recommendation-journey",e),this.state=n,this.emailThis=new a.EmailThis(this.root,this.state)}return __extends(r,t),r.prototype.render=function(t){var r=this,a=o.get(".recommendations",this.root),c=o.get("template",a);t.length>0&&(this.state.popup_info={position:"recommendation-1"}),t.forEach(function(u,l){var h=l+1,p=i.Templates.clone(c),d="-"+h;new e.RecommendationRenderer(p).render(u);var f={"data-recommendation-doi":u.doi,"data-recommendation-dois":[u.doi],"data-recommendation-issn":u.issn,"data-recommendation-position":String(h),"data-total-recommendations":String(t.length),"data-randomised-recommendation":String(u.randomised),"data-recommendation-link":u.raw_link},m=o.get(".title",p),g=new n.StructuredText;g.process(m),o.select(".next",p).on("click",function(t){var e=Number(t.getAttribute("data-recommendation-position"));return r.state.popup_info.position="recommendation-"+(e+1),
!0}),o.select(".previous",p).on("click",function(t){var e=Number(t.getAttribute("data-recommendation-position"));return r.state.popup_info.position="recommendation-"+(e-1),!0}),o.select("input[name=recommendation-position]",p).on("change",function(){g.process(m)}).map(s.attributes(f,{value:String(h),id:function(t){return t+d},checked:1==h}));var _=o.get("label[for=uptodate-recommendation-position].debug",p);_.htmlFor+=d,o.select(".text",_).text(String(h)),o.get(".current-recommendation",p).textContent=String(h),o.get(".total-recommendations",p).textContent=String(t.length),o.select("label[for=uptodate-recommendation-position].next",p).map(s.attributes(f,{for:function(e){return e+"-"+(h==t.length?1:h+1)}})),l>0&&o.select("label[for=uptodate-recommendation-position].previous",p).map(s.attributes(f,{for:function(t){return t+"-"+(h-1)}})),a.appendChild(p)}),this.emailThis.attachToForm()},r.prototype.display=function(t){this.position(this.position(),t)},r.prototype.position=function(t,e){return t?Number(this.set("recommendation-position",String(t),e)):Number(this.get("recommendation-position"))},r}(r.Component);return t.RecommendationJourney=c,t}(recommendation_journey_recommendation_journey,recommendation_recommendation,text_text,shared_component,shared_selection,shared_templates,shared_html,email_this_email_this),minimised_minimised=function(t,e,n){var r=function(){function t(t){this.parent=t,this.element=e.get(".minimised",t)}return t.prototype.initial=function(t){void 0===t&&(t=!0),this.check("minimised-state","initial",t)},t.prototype.notification=function(t){void 0===t&&(t=!0),this.check("minimised-state","notification",t)},t.prototype.check=function(t,r,o){void 0===o&&(o=!0);var i=e.get("input[name="+t+"][value="+r+"]",this.element);i.checked=!0,o&&i.dispatchEvent(n.Events.create("change"))},t}();return t.Minimised=r,t}(minimised_minimised,shared_selection,shared_events);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};email_journey_email=function(t,e,n,r,o,i,s){var a=function(t){function r(e,n){t.call(this,".email",e),this.state=n,this.elementName="email-journey",this.attachToForm()}return __extends(r,t),r.prototype.attachToForm=function(){var t=this,r=o.get(".card-subscribe",this.root);i.on(r,"submit",function(){r.action=t.state.config.host+"subscribe";var i=o.get("input[name=state]",r);return i.value=JSON.stringify(t.state),t.subscribing(),s.Debug.log("attempting to subscribe"),e.http(n.request(r),function(e){e.status>=299?(s.Debug.log("failed to subscribe"),t.error()):(s.Debug.log("succeeded in subscribing"),t.subscribed())}),!1})},r.prototype.signup=function(){this.state.popup_info.position="email-signup",this.set(this.elementName,"signup")},r.prototype.subscribe=function(){this.state.popup_info.position="email-subscribe",this.set(this.elementName,"subscribe"),this.set("subscribe-state","initial")},r.prototype.subscribing=function(){this.state.popup_info.position="email-subscribing",this.set("subscribe-state","subscribing")},r.prototype.error=function(){this.state.popup_info.position="email-error",this.set("subscribe-state","error")},r.prototype.subscribed=function(){this.state.popup_info.position="email-subscribed",this.set(this.elementName,"subscribed")},r}(r.Component);return t.EmailJourney=a,t}(email_journey_email,shared_http,shared_forms,shared_component,shared_selection,shared_html,shared_errors),shared_scroll=function(t,e,n){var r=function(){function t(t){this.config=t}return t.prototype.required=function(){return e.hasVerticalScrollBar()&&!this.hasScrolledEnough()},t.prototype.hasScrolledEnough=function(){return window.pageYOffset>this.config.minimum_scroll_height},t.prototype.await=function(t){var e=this,n=function(){e.hasScrolledEnough()&&(window.removeEventListener("scroll",n),t())};window.addEventListener("scroll",n)},t}();t.WindowScrollCondition=r;var o=function(){function t(t,e,n){var r=this;this.sender=t,this.receiver=e,this.state=n,this.receiver.scroll_info=function(t){return r.scroll_info(t)},this.receiver.scroll_bars_response=function(t){return r.scroll_bars_response(t)},this.sender.send("scroll_bars_request")}return t.prototype.scroll_bars_response=function(t){this.scrollBars=t},t.prototype.scroll_info=function(t){if(this.scrollInfo=t,this.done&&this.hasScrolledEnough()){var e=this.done;this.done=null,this.sender.send("scroll_info_stop"),e()}},t.prototype.required=function(){return this.scrollBars&&this.scrollBars.vertical&&!this.hasScrolledEnough()},t.prototype.getScrolledPosOffset=function(t,e){var n=this.state.config.experiment_popup_scroll_position?.75:1,r=e-t,o=r*(1-n);return o},t.prototype.hasScrolledEnough=function(){if(this.scrollInfo&&this.scrollInfo.targetClientRect){if(0===this.scrollInfo.targetClientRect.top&&0===this.scrollInfo.targetClientRect.bottom)return!1;var t=this.scrollInfo.targetClientRect.top,e=this.scrollInfo.targetClientRect.bottom;if("inline"===this.state.current_location.display_type)return e>0&&t<this.scrollInfo.windowHeight;var n=this.getScrolledPosOffset(t,e);return e<0||e-n<this.scrollInfo.windowHeight}return this.scrollInfo&&this.scrollInfo.y>this.state.config.minimum_scroll_height},t.prototype.await=function(t){this.done=t,this.sender.send("scroll_info_start")},t}();t.ClientScrollListener=o;var i=function(){function t(t,e,n){var r=this;this.sender=t,this.receiver=e,this.state=n,this.receiver.jobs_scroll_info=function(t){return r.scroll_info(t)},this.receiver.jobs_scroll_bars_response=function(t){return r.scroll_bars_response(t)},this.sender.send("jobs_scroll_bars_request")}return t.prototype.scroll_bars_response=function(t){this.scrollBars=t},t.prototype.scroll_info=function(t){if(this.scrollInfo=t,this.done&&this.hasScrolledEnough()){var e=this.done;e(),this.done=null,this.sender.send("jobs_scroll_info_stop")}},t.prototype.required=function(){return!this.hasScrolledEnough()},t.prototype.hasScrolledEnough=function(){if(this.scrollInfo&&this.scrollInfo.targetClientRect){if(0===this.scrollInfo.targetClientRect.top&&0===this.scrollInfo.targetClientRect.bottom)return!1;var t=this.scrollInfo.targetClientRect.top,e=this.scrollInfo.targetClientRect.bottom;return e>0&&t<this.scrollInfo.windowHeight}return this.scrollInfo&&this.scrollInfo.y>this.state.config.minimum_scroll_height},t.prototype.await=function(t){this.done=t,this.sender.send("jobs_scroll_info_start")},t}();t.JobClientScrollListener=i;var s=function(){function t(t,e,n){var r=this;this.sender=t,this.receiver=e,this.state=n,this.receiver.scroll_info_start=function(){return r.start()},this.receiver.scroll_info_stop=function(){return r.stop()},this.receiver.scroll_bars_request=function(){return r.scroll_bars_request()}}return t.prototype.scroll_bars_request=function(){this.sender.send("scroll_bars_response",{vertical:e.hasVerticalScrollBar(),horizontal:e.hasHorizontalScrollBar()})},t.prototype.start=function(){var t=this;this.handler=window.setInterval(function(){function e(){var t="div#abstract",e="section[aria-labelledby='abstract'], section[aria-labelledby='Abs1']",r="section.Abstract";return n.get(t+", "+e+", "+r)}function r(t,e){var n=e.getBoundingClientRect();return t.windowHeight=window.innerHeight,t.targetClientRect={top:n.top,bottom:n.bottom},t}var o={x:window.pageXOffset,y:window.pageYOffset},i=null,s=null;"inline"===t.state.current_location.display_type&&(i=n.get("#uptodate-client"))?o=r(o,i):(s=e())&&(o=r(o,s)),t.sender.send("scroll_info",o)},250)},t.prototype.stop=function(){window.clearInterval(this.handler)},t}();t.HostScrollListener=s;var a=function(){function t(t,e,n){var r=this;this.sender=t,this.receiver=e,this.state=n,this.receiver.jobs_scroll_info_start=function(){return r.start()},this.receiver.jobs_scroll_info_stop=function(){return r.stop()},this.receiver.jobs_scroll_bars_request=function(){return r.scroll_bars_request()}}return t.prototype.scroll_bars_request=function(){this.sender.send("jobs_scroll_bars_response",{vertical:e.hasVerticalScrollBar(),horizontal:e.hasHorizontalScrollBar()})},t.prototype.start=function(){var t=this;this.handler=window.setInterval(function(){var e=n.get("#job-client");if(e){var r=e.getBoundingClientRect(),o={x:window.pageXOffset,y:window.pageYOffset,windowHeight:window.innerHeight,targetClientRect:{top:r.top,bottom:r.bottom}};t.sender.send("jobs_scroll_info",o)}},250)},t.prototype.stop=function(){window.clearInterval(this.handler)},t}();return t.JobHostScrollListener=a,t}(shared_scroll,shared_html,shared_selection),shared_functions=function(t,e){function n(t,n){return setTimeout(e.UnhandledError.capture(n),t)}function r(t,n){var r=-1;return function(){r!=-1&&clearTimeout(r),r=setTimeout(e.UnhandledError.capture(n),t)}}return t.delay=n,t.idle=r,t}(shared_functions,shared_errors);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};pre_rec_email_journey_pre_rec_email=function(t,e,n,r,o,i,s){var a=function(t){function e(e,n){t.call(this,".pre-rec-email",e),this.state=n,this.elementName="pre-rec-email-journey",this.attachToForm()}return __extends(e,t),e.prototype.attachToForm=function(){var t=this,e=r.get(".card-subscribe",this.root);n.on(e,"submit",function(){e.action=t.state.config.host+"subscribe";var n=r.get("input[name=state]",e);return n.value=JSON.stringify(t.state),t.subscribing(),o.Debug.log("attempting to subscribe"),i.http(s.request(e),function(e){e.status>=299?(o.Debug.log("failed to subscribe"),t.error()):(o.Debug.log("succeeded in subscribing"),t.subscribed())}),!1})},e.prototype.signup=function(){this.state.popup_info.position="email-pre-rec",this.set(this.elementName,"email-signup")},e.prototype.subscribe=function(){this.state.popup_info.position="email-pre-rec-subscribe",this.set(this.elementName,"subscribe"),this.set("subscribe-state","initial")},e.prototype.subscribing=function(){this.state.popup_info.position="email-pre-rec-subscribing",this.set("subscribe-state","subscribing")},e.prototype.error=function(){this.state.popup_info.position="email-pre-rec-error",this.set("subscribe-state","error")},e.prototype.subscribed=function(){this.state.popup_info.position="email-pre-rec-subscribed",this.set(this.elementName,"subscribed")},e}(e.Component);return t.PreRecEmail=a,t}(pre_rec_email_journey_pre_rec_email,shared_component,shared_html,shared_selection,shared_errors,shared_http,shared_forms);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};pre_rec_plugin_journey_pre_rec_plugin=function(t,e){var n=function(t){function e(e,n){t.call(this,".pre-rec-plugin",e),this.state=n,this.elementName="pre-rec-plugin-journey"}return __extends(e,t),e.prototype.show=function(){this.state.popup_info.position="plugin-pre-rec",this.set(this.elementName,"plugin")},e}(e.Component);return t.PreRecPlugin=n,t}(pre_rec_plugin_journey_pre_rec_plugin,shared_component),shared_cookies=function(t){var e=function(){function t(){}return t.getItem=function(t){return t?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},t.setItem=function(t,e,n,r,o,i){if(!t||/^(?:expires|max-age|path|domain|secure)$/i.test(t))return!1;var s="";if(n)switch(n.constructor){case Number:s=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:s="; expires="+n;break;case Date:s="; expires="+n.toUTCString()}return document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+s+(o?"; domain="+o:"")+(r?"; path="+r:"")+(i?"; secure":""),!0},t.removeItem=function(t,e,n){if(!this.hasItem(t))return!1;var r=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(e?"; path="+e:"");return document.cookie=r,!0},t.hasItem=function(t){return!!t&&new RegExp("(?:^|;\\s*)"+encodeURIComponent(t).replace(/[\-.+*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},t.keys=function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^=]+)(?=;|$)|^\s*|\s*(?:=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:=[^;]*)?;\s*/),e=t.length,n=0;n<e;n++)t[n]=decodeURIComponent(t[n]);return t},t}();return t.Cookies=e,t}(shared_cookies);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};popup_popup=function(t,e,n,r,o,i,s,a,c,u,l,h){var p=function(t){function a(i,s,a,c){void 0===c&&(c=new o.WindowScrollCondition(s.config)),t.call(this,".popup",i),this.state=s,this.config=a,this.scroll=c,this.numberOfRecommendations=0,this.checks={email:{check:function(){return!this.state.config.user_registered&&!this.state.config["email-journey-closed"]},display:this.displayEmailPreRecJourney},plugin:{check:function(){return!this.state.current_location.browser_extension_loaded&&!this.state.config["plugin-journey-closed"]},display:this.displayPluginPreRecJourney},recommendations:{check:function(){return!0},display:this.openRecommendationJourney}},this.minimised=new n.Minimised(this.root),this.recommendationJourney=new e.RecommendationJourney(this.root,s),this.emailJourney=new r.EmailJourney(this.root,s),this.preRecEmail=new u.PreRecEmail(this.root,s),this.preRecPlugin=new l.PreRecPlugin(this.root,s)}return __extends(a,t),a.prototype.render=function(t){this.numberOfRecommendations=t.length,this.recommendationJourney.render(t),this.insertOnwardJourney(),this.handleClose(),this.handleEmailThis()},a.prototype.insertOnwardJourney=function(){var t=this;s.select(".recommendations .next",this.root).on("click",function(e){var n=e,r=Number(n.getAttribute("data-recommendation-position")),o=Math.min(t.numberOfRecommendations,t.state.config.onward_journey_position);return!(o==r&&!t.state.config.user_registered)||(s.get(".onward",t.root).className=s.get(".onward",t.root).className.replace("disable-animate",""),t.displayEmailJourney(),!1)}),this.state.config.user_registered||this.incrementTotal()},a.prototype.incrementTotal=function(){s.select(".total-recommendations",this.root).map(function(t){return t.textContent=String(Number(t.textContent)+1)})},a.prototype.display=function(){var t=this;return this.scroll.required()?this.scroll.await(function(){return t.display()}):void(0!=this.numberOfRecommendations&&(this.state.config.minimised||"true"==h.Cookies.getItem("uptodate-minimised")?(this.fireResize({width:"100px",height:"100px"}),this.minimise(),this.minimised.notification()):this.open()))},a.prototype.handlerJourneys=function(){this.hasState("journey","pre-rec")&&(this.hasState("pre-rec","email-journey")&&this.config.persist("email-journey-closed","true"),this.hasState("pre-rec","plugin-journey")&&this.config.persist("plugin-journey-closed","true"))},a.prototype.handleClose=function(){var t=this;s.select(".cancel, .no-thanks, .done",this.root).on("click",function(){return t.handlerJourneys(),t.openRecommendationJourney(),i.delay(1e3,function(){t.emailJourney.reset(!1,!1)}),!1}),s.select(".maximise",this.root).on("click",function(){return t.config.data.minimised=!1,t.config.persist("minimised","false"),h.Cookies.setItem("uptodate-minimised","false"),t.minimised.initial(),t.open(),!1}),s.select(".close[for=uptodate-popup-minimised]",this.root).on("click",function(){return t.hasState("journey","recommendation")&&t.hasState("recommendation-position","1")&&(t.config.data.minimised=!0,t.config.persist("minimised","true"),h.Cookies.setItem("uptodate-minimised","true")),t.handlerJourneys(),t.hasState("journey","pre-rec")?(t.openRecommendationJourney(),!1):(t.minimise(),!0)}),s.select(".minimised, .journeys",this.root).on(["transitionend","webkitTransitionEnd"],function(e,n){if("visibility"==n.propertyName){c.Debug.log(n);var r=s.get("input[name=popup]:checked",t.root);switch(c.Debug.log(r.value),r.value){case"minimised":var o=s.get("input[name=minimised-state]:checked",t.root);"notification"!=o.value&&t.fireResize({width:"80px",height:"80px"});break;case"closed":t.fireResize({width:"0",height:"0"})}}}),s.select(".minimised",this.root).on(["animationend","webkitAnimationEnd"],function(e,n){"uptodate-sonar"==n.animationName&&(c.Debug.log(n),t.fireResize({width:"80px",height:"80px"}))})},a.prototype.open=function(){var t=this,e=this.state.config.journey_order.value||["recommendations"],n=e.filter(function(e){return t.checks[e].check.call(t)})[0];this.checks[n].display.call(this),this.set("popup","open")},a.prototype.openRecommendationJourney=function(){this.hasState("journey","recommendation")?this.recommendationJourney.display():(this.displayRecommendationsJourney(),this.recommendationJourney.position(1)),this.fireResize(s.get(".recommendation-journey",this.root))},a.prototype.showEmailPreRec=function(){return this.state.config.experiment_email_position&&!this.state.config.user_registered&&!this.state.config["closed-pre-rec-email"]},a.prototype.close=function(){this.set("popup","close")},a.prototype.minimise=function(){this.set("popup","minimised")},a.prototype.displayRecommendationsJourney=function(){this.set("journey","recommendation")},a.prototype.displayEmailJourney=function(){this.set("onward","email-journey"),this.emailJourney.signup(),this.fireResize(s.get(".onward",this.root)),this.set("journey","onward")},a.prototype.displayEmailPreRecJourney=function(){this.preRecEmail.signup(),this.set("pre-rec","email-journey"),this.fireResize(s.get(".pre-rec",this.root)),this.set("journey","pre-rec")},a.prototype.displayPluginPreRecJourney=function(){this.preRecPlugin.show(),this.set("pre-rec","plugin-journey"),this.fireResize(s.get(".pre-rec",this.root)),this.set("journey","pre-rec")},a.prototype.displaySafariJourney=function(){this.fireResize(s.get(".safari",this.root)),this.set("journey","safari")},a.prototype.handleEmailThis=function(){var t=this;s.select(".email-this-input",this.root).on("change",function(){var e=s.get(".recommendation-journey",t.root);return t.fireResize(e),i.delay(500,function(){t.recommendationJourney.emailThis.reset(!1,!1)}),!0}),s.select(".email-this-signup",this.root).on("click",function(){var e=s.get("#uptodate-send-email",t.root),n=s.get("#uptodate-subscribe-email",t.root);return n.value=e.value,t.set("onward","email-journey"),t.emailJourney.signup(),i.delay(1e3,function(){t.recommendationJourney.emailThis.reset(!1,!1),s.get("#uptodate-email-this",t.root).checked=!1}),t.fireResize(s.get(".onward",t.root)),t.set("journey","onward"),!0})},a}(a.Component);return t.Popup=p,t}(popup_popup,recommendation_journey_recommendation_journey,minimised_minimised,email_journey_email,shared_scroll,shared_functions,shared_selection,shared_component,shared_errors,pre_rec_email_journey_pre_rec_email,pre_rec_plugin_journey_pre_rec_plugin,shared_cookies);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};inline_inline=function(t,e,n,r,o,i,s){var a=function(t){function r(e,n,r){t.call(this,".inline",e),this.state=n,this.scroll=r,this.events=new s.Events(n)}return __extends(r,t),r.prototype.render=function(t){this.recommendations=t;var r=n.get(".recommendations",this.root),s=n.get("template",r);t.forEach(function(t){var a=i.Templates.clone(s);new e.RecommendationRenderer(a).render(t);var c=n.get(".title",a),u=new o.StructuredText;u.process(c),r.appendChild(a)})},r.prototype.display=function(){return 0==this.recommendations.length?(this.fireInlineEvent("uptodate-no-content"),void this.events.fire("inline","displays","no-recommendation")):(this.fireInlineEvent("uptodate-display"),this.open(),void this.displayEvent())},r.prototype.displayEvent=function(){var t=this;if(this.scroll.required())return this.scroll.await(function(){return t.displayEvent()});var e={"recommendation-dois":this.recommendations.map(function(t){return t.doi}),"total-recommendations":this.recommendations.length,"randomised-recommendation":!1};this.events.fire("inline","displays","recommendation",e)},r.prototype.open=function(){this.fireResize({width:"100%",height:this.root.offsetHeight+"px"})},r}(r.Component);return t.Inline=a,t}(inline_inline,recommendation_recommendation,shared_selection,shared_component,text_text,shared_templates,shared_events),config_config=function(t,e,n,r,o,i,s,a,c){var u=function(){function t(n,o){var i=this;this.parent=o,this.storage=window.localStorage,this.parent.config=this,e.copyIntoStorage(s.queryObject(n.current_location.url),this.storage,t.prefix),this.data=this.migrate(c.mergeObjects(n.config,t.extractConfig(e.storageObject(this.storage)))),this.render(),r.select("#"+this.id("debug")).on("change",function(t){i.debug(t.checked)}),this.persist("debug",null),this.debug(a.Debug.isDebug(n.current_location.url))}return t.extractConfig=function(e){var r=this;return Object.keys(e).reduce(function(o,i){if(n.startsWith(r.prefix,i)){var s=i.substr(t.prefix.length);o[s]=e[i]}return o},{})},t.prototype.json=function(){return JSON.stringify(this.data)},t.prototype.render=function(){var t=this;Object.keys(this.data).forEach(function(e){t.createProperty(e,t.data[e])})},t.prototype.createProperty=function(t,e){var i=this.id(t),s=typeof e,a=r.get("#"+i,this.parent);if(a)"boolean"==s?a.checked=e:a.value=JSON.stringify(e);else{var c=r.get("template.config",this.parent),u=o.Templates.clone(c);a=r.get("input",u),"boolean"==s?a.setAttribute("type","checkbox"):"number"==s?a.setAttribute("type","number"):a.setAttribute("type","text"),a.setAttribute("id",i),a.classList.add(t.replace(/_/g,"-")),"boolean"==s?e?a.setAttribute("checked",""):a.removeAttribute("checked"):a.setAttribute("value",JSON.stringify(e));var l=r.get("label",u);l.setAttribute("for",i);var h=r.get(".text",l);h.textContent=t.replace(/_/g," "),this.parent.insertBefore(u,c.nextSibling)}Object.defineProperty(this.data,t,{enumerable:!0,get:function(){return"boolean"==s?a.checked:n.coerce(a.value)},set:function(t){return"boolean"==s?a.checked=t:a.value=JSON.stringify(t)}})},t.prototype.id=function(e){return t.prefix+e.replace(/_/g,"-")},t.prototype.debug=function(t){a.Debug.enable(t),this.full_screen(t),t?this.parent.classList.add("debug"):this.parent.classList.remove("debug")},t.prototype.full_screen=function(t){i.MessageDispatcher.dispatch(this.parent,{name:"full_screen",body:t})},t.prototype.persist=function(e,n){var r=t.prefix+e;null==n?this.storage.removeItem(r):this.storage.setItem(r,n)},t.prototype.isPersisted=function(e){var n=t.prefix+e;return null!==this.storage.getItem(n)},t.prototype.migrate=function(t){return this.migrateProperty(t,"closed-pre-rec-email","email-journey-closed"),t},t.prototype.migrateProperty=function(t,e,n){var r=t[e];"undefined"!=typeof r&&(t[n]=r,this.isPersisted(e)&&(this.persist(e,null),this.persist(n,r)))},t.prefix="uptodate-",t}();return t.Config=u,t}(config_config,shared_storage,shared_strings,shared_selection,shared_templates,shared_messaging,shared_http,shared_errors,shared_collections),application_application=function(t,e,n,r,o,i,s,a,c,u,l,h,p,d){var f=function(){function t(t,e,n,r){var o=this;void 0===e&&(e=null),void 0===n&&(n=new c.Events(t)),void 0===r&&(r=new s.WindowScrollCondition(t.config)),this.state=t,this.recommendations=e,this.events=n,this.scroll=r;try{this.setup()}catch(t){this.handle(t)}h.UnhandledError.unhandled=function(t){return o.handle(t)}}return t.prototype.handle=function(t){if(this.state.config.debug)throw t;this.events.fire("client","throws","error",{name:t.name,message:t.message,stack:t.stack?t.stack:""})},t.prototype.setup=function(){var t=this;this.cleanupCookie();var e=u.get("#uptodate",document);if(!e)return this.loadAssets(function(){return t.setup()});var n=u.get(".application",e);n.application=this,this.config=new i.Config(this.state,n),this.state.config=this.config.data,this.state.config.inline_version&&"inline"==this.state.current_location.display_type?this.displayComponent=new o.Inline(n,this.state,this.scroll):(this.state.current_location.display_type="popup",this.state.config.inline_version=!1,this.displayComponent=new r.Popup(n,this.state,this.config,this.scroll)),new a.StateChange(n,this.events),this.display()},t.prototype.cleanupCookie=function(){var t=window.location.hostname;h.Debug.log("COOKIE host: "+t),"recommendations.springernature.com"==t&&(h.Debug.log("COOKIE deleting cookie: "+t),p.Cookies.removeItem("nature_impact_pd","/","recommendations.springernature.com"));var e="springernature.com";d.endsWith(e,t)&&(h.Debug.log("COOKIE setting new cookie for domain: "+e),p.Cookies.setItem("nature_impact_pd",this.state.config.user_id,1/0,"/",e))},t.prototype.loadAssets=function(r){e.http(n.Requests.get(this.state.config.host+t.assets),function(t){if(200==t.status){var e=t.entity.html(),n=u.get("#uptodate",e);l.Templates.polyfillTemplates(n),document.body.appendChild(n),r()}})},t.prototype.display=function(){var t=this;return null==this.recommendations?this.loadRecommendations(function(){return t.display()}):(this.displayComponent.render(this.recommendations),void this.displayComponent.display())},t.prototype.loadRecommendations=function(t){var r=this;if(this.state.config.inline_version)switch(this.state.current_location.hostsite){case"recommended":this.state.config.number_of_recommendations=2;break;case"springer":this.state.config.number_of_recommendations=3;break;case"nature":this.state.config.experiment_srep_homepage===!0&&(this.state.config.number_of_recommendations=1e3,this.state.config.minimum_confidence=10)}this.state.config.user_registered&&"popup"===this.state.current_location.display_type&&(this.state.config.number_of_recommendations=10),e.http(n.Requests.recommendations(this.state),function(e){200==e.status&&(r.recommendations=e.entity.json(),r.state.config.experiment_srep_homepage===!0&&(r.recommendations=r.recommendations.filter(function(t){return"2045-2322"===t.issn}).slice(0,6)),r.recommendations.length<3&&(r.recommendations=[]),t())})},t.assets="application/application.html",t}();return t.Application=f,t}(application_application,shared_http,shared_requests,popup_popup,inline_inline,config_config,shared_scroll,shared_state,shared_events,shared_selection,shared_templates,shared_errors,shared_cookies,shared_strings);var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};iframe_client=function(t,e,n,r,o,i,s,a){var c=function(t){function c(){var e=this,r=n.BaseUrl.baseUrl("client.js"),a=n.BaseUrl.origin(n.queryObject().source);o.Debug.log("ARTICLE Client expecting to send and receive messages from "+a),t.call(this,window,a),this.sender=new i.MessageSender([window.parent],a),this.baseUrl=r,this.sender.send("state_request"),this.sender.send("inline_css_request"),s.select(document.body).on("client_message",function(t,n){var r=n.detail;e.sender.send(r.name,r.body)},!0)}return __extends(c,t),c.prototype.state_response=function(t){new e.Application(t,null,new a.Events(t),new r.ClientScrollListener(this.sender,this,t))},c.prototype.inline_css_response=function(t){var e=document.createElement("link");e.rel="stylesheet",e.href=t,window.document.head.appendChild(e),window.addEventListener("resize",function(t){o.Debug.log("resize event from iframe");var e=s.get(".application",document);return i.MessageDispatcher.fireResize(e,{height:e.offsetHeight+"px",width:"100%"}),!0})},c}(i.MessageReceiver);try{new c}catch(t){o.UnhandledError.unhandled(t)}return t}(iframe_client,application_application,shared_http,shared_scroll,shared_errors,shared_messaging,shared_selection,shared_events);
//# sourceMappingURL=client.js.map
